// Generated by CoffeeScript 1.3.1
(function(){var a,b,c,d,e,f,g,h,i,j,k={}.hasOwnProperty,l=function(a,b){function d(){this.constructor=a}for(var c in b)k.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},m=function(a,b){return function(){return a.apply(b,arguments)}};$.ajax.compat&&$.ender({ajax:$.ajax.compat}),b=require("backbone"),a=20,i=6e3,h=1e3,f=function(b){function c(){return c.__super__.constructor.apply(this,arguments)}return l(c,b),c.name="Guest",c.prototype.initialize=function(){return this.set("y",Math.random()),this.death=Math.floor(Math.log(Math.random())/Math.log(1-1/a))+1},c.prototype.defaults={x:0,y:0,age:0},c.prototype.tick=function(){return this.set({x:Math.random(),y:Math.random(),age:this.get("age")+1})},c}(b.Model),g=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return l(b,a),b.name="GuestList",b.prototype.model=f,b.prototype.removeExpired=function(){var a;return a=this.length,this.remove(this.filter(function(a){return a.get("age")>=a.death}))},b.prototype.addNew=function(){return this.unshift({})},b}(b.Collection),c=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return l(b,a),b.name="Day",b}(b.Model),d=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return l(b,a),b.name="Days",b.prototype.model=c,b}(b.Collection),e=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return l(b,a),b.name="Exhibition",b.prototype.guestList=new g,b.prototype.initialize=function(){return this.bind("change:currentDay",function(){return this.guestList.reset()})},b.prototype.url=function(){return"/"+this.id+".json"},b.prototype.parse=function(a){var b,c;return c=new d(function(){var c,d,e,f;e=a.data,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push({date:b.date,traffic:b.traffic});return f}()),this.set({currentDay:c.first(),days:c,event:a.event})},b.prototype.currentRate=function(){return this.get("currentDay").get("traffic")[0]},b.prototype.currentInterval=function(){return 9-this.get("currentDay").get("traffic").length},b.prototype.nextNewGuest=function(){return this.currentRate()>0?-1/this.currentRate()*Math.log(Math.random()):-1},b.prototype.addGuest=function(){return this.guestList.addNew()},b.prototype.advance=function(){return this.currentInterval()===8?(this.get("days").shift(),this.set("currentDay",this.get("days").first())):this.get("currentDay").get("traffic").shift(),this.currentInterval()===8?3:1},b}(b.Model),j=function(a){function b(){return this.tick=m(this.tick,this),this.addNew=m(this.addNew,this),this.render=m(this.render,this),this.renderDate=m(this.renderDate,this),this.renderTitle=m(this.renderTitle,this),b.__super__.constructor.apply(this,arguments)}return l(b,a),b.name="Tramway",b.prototype.el="#content",b.prototype.timescale=d3.scale.linear().domain([0,1]).range([0,i]),b.prototype.initialize=function(){var a=this;return this.width=innerWidth-20,this.height=innerHeight-20,this.xscale=d3.scale.linear().domain([0,1]).range([0,this.width]),this.yscale=d3.scale.linear().domain([0,1]).range([0,this.height]),this.svg=d3.select(this.el).append("svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate(20, 20)"),this.svg.append("text").attr("class","title").attr("dy",".71em"),this.svg.append("text").attr("class","date").attr("transform","translate(0, "+(this.height-40)+")"),this.model.bind("change",function(){a.renderTitle(),a.renderDate();if(a.renderInterval==null)return a.renderInterval=setInterval(a.render,h),a.addNew(),a.tick()})},b.prototype.renderTitle=function(){return this.svg.selectAll("text.title").data([this.model.get("event")]).text(String)},b.prototype.renderDate=function(){return this.svg.select("text.date").data([this.model.get("currentDay").get("date")]).text(String),this},b.prototype.render=function(){var a,b,c=this;return this.model.guestList.removeExpired(),a=this.svg.selectAll("circle.man").data(this.model.guestList.toArray(),function(a){return a.cid}),a.enter().append("circle").attr("class","man").attr("cx",function(a){return c.xscale(a.get("x"))}).attr("cy",function(a){return c.yscale(a.get("y"))}).attr("r",10),b=this.model.guestList.length,a.transition().duration(h).delay(function(a,c){return c/b*h}).ease("linear").attr("cx",function(a){return c.xscale(a.get("x"))}).attr("cy",function(a){return c.yscale(a.get("y"))}).each(function(a){return a.tick()}),a.exit().transition().attr("r",0).remove()},b.prototype.addNew=function(){var a;return a=this.model.nextNewGuest(),a>=0?(this.model.addGuest(),window.setTimeout(this.addNew,this.timescale(this.model.nextNewGuest()))):this.sleeping=!0},b.prototype.tick=function(){var a;return a=this.model.advance(),this.sleeping&&(this.sleeping=!1,window.setTimeout(this.addNew,this.timescale(this.model.nextNewGuest()))),window.setTimeout(this.tick,i*a)},b}(b.View),this.ex=new e({id:"eladlassry"}),this.tramway=new j({model:this.ex}),this.ex.fetch()}).call(this);